<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Bridging ICU with Ruby - Blog</title>
<meta name="description" content="Chinese Discourse users have more complains to the text problems. A community software induce users to read and write which certainly deals with texts. Numerous efforts are made along the way such as tokenizers for Chinese. Maintaining a project is not easy. One of feature request for Discourse is Unicode username. A core technical problem is visually confusing username. Discourse community may be in a multilingual community. This is certainly important to deal with. Although username is the core identify of the user representation. It’s more than Unicode.  ">


  <meta name="author" content="Erick Guan">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Blog">
<meta property="og:title" content="Bridging ICU with Ruby">
<meta property="og:url" content="https://erickguan.me/2017/bridging-icu-with-ruby">


  <meta property="og:description" content="Chinese Discourse users have more complains to the text problems. A community software induce users to read and write which certainly deals with texts. Numerous efforts are made along the way such as tokenizers for Chinese. Maintaining a project is not easy. One of feature request for Discourse is Unicode username. A core technical problem is visually confusing username. Discourse community may be in a multilingual community. This is certainly important to deal with. Although username is the core identify of the user representation. It’s more than Unicode.  ">





  <meta name="twitter:site" content="@erickguan">
  <meta name="twitter:title" content="Bridging ICU with Ruby">
  <meta name="twitter:description" content="Chinese Discourse users have more complains to the text problems. A community software induce users to read and write which certainly deals with texts. Numerous efforts are made along the way such as tokenizers for Chinese. Maintaining a project is not easy. One of feature request for Discourse is Unicode username. A core technical problem is visually confusing username. Discourse community may be in a multilingual community. This is certainly important to deal with. Although username is the core identify of the user representation. It’s more than Unicode.  ">
  <meta name="twitter:url" content="https://erickguan.me/2017/bridging-icu-with-ruby">

  
    <meta name="twitter:card" content="summary">
    
  

  
    <meta name="twitter:creator" content="@erickguan">
  



  <meta property="article:published_time" content="2017-03-14T00:00:00+01:00">





  

  


<link rel="canonical" href="https://erickguan.me/2017/bridging-icu-with-ruby">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Erick Guan",
      "url": "https://erickguan.me/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#da532c">
<meta name="apple-mobile-web-app-title" content="Erick Guan">
<meta name="application-name" content="Erick Guan">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Bridging ICU with Ruby">
    <meta itemprop="description" content="Chinese Discourse users have more complains to the text problems. A communitysoftware induce users to read and write which certainly deals with texts.Numerous efforts are made along the way such as tokenizers for Chinese. Maintaininga project is not easy.One of feature request for Discourse is Unicode username. A core technical problemis visually confusing username. Discourse community may be in a multilingualcommunity. This is certainly important to deal with. Although username is thecore identify of the user representation. It’s more than Unicode.">
    <meta itemprop="datePublished" content="2017-03-14T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Bridging ICU with Ruby
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Chinese Discourse users have more complains to the text problems. A community
software induce users to read and write which certainly deals with texts.
Numerous efforts are made along the way such as tokenizers for Chinese. Maintaining
a project is not easy.
One of feature request for Discourse is Unicode username. A core technical problem
is visually confusing username. Discourse community may be in a multilingual
community. This is certainly important to deal with. Although username is the
core identify of the user representation. It’s more than Unicode.</p>

<h2 id="motivation-and-goals">Motivation and goals</h2>

<p>Somehow, Ruby community doesn’t have much tools for Unicode processing. Unicode
normalization is implemented in the core library in 2.2. And what about <a href="http://unicode.org/reports/tr36/">Unicode
security problems</a>? I don’t want to reinvent the
wheel.
<a href="http://site.icu-project.org/">ICU (International Components for Unicode)</a> is an old and battle-tested
library for the Unicode. A binding with it would worth it. It should have
high performance, easy to maintain and can be deployed with MRI.</p>

<p>There are already some gems.</p>
<ul>
  <li><a href="https://github.com/twitter/twitter-cldr-rb"><code class="language-plaintext highlighter-rouge">twitter-cldr-rb</code> gem</a> is a pure
Ruby implementation based on <a href="http://cldr.unicode.org/">Unicode CLDR</a>. Adding
feature means implementing algorithm on the unicode document.</li>
  <li>Some existing gems are obsolete.</li>
  <li>The binding with ICU is <a href="https://bugs.ruby-lang.org/issues/2034">discussed in MRI tracker</a>.</li>
</ul>

<h2 id="do-it-right">Do it right</h2>

<p>Ruby is really different than other programing languages in terms of its string
implementation. <a href="http://yokolet.blogspot.se/2009/07/design-and-implementation-of-ruby-m17n.html">The <em>Code Set Independent</em> (CSI) model</a>
doesn’t set a common internal encoding but stores the bytes presentation
with encoding information. It allows Ruby convert encodings when it involves I/O operations.
Also, Ruby holds the external encoding <code class="language-plaintext highlighter-rouge">Encoding.default_external</code> which is how Ruby
reads from an IO object. The <code class="language-plaintext highlighter-rouge">IO</code> object is typically a file (<code class="language-plaintext highlighter-rouge">File</code> is a subclass of IO).
The <code class="language-plaintext highlighter-rouge">Encoding.default_internal</code> for new created string is usually UTF-8 from the environment.
<a href="http://nuclearsquid.com/writings/ruby-1-9-encodings/">This starts from Ruby 1.9</a>.</p>

<p>ICU provides <a href="http://userguide.icu-project.org/i18n">many internationalization features</a>. It operates with strings.
So the most operations happen in memory. But ICU <a href="http://userguide.icu-project.org/strings">uses UTF-16 internally</a>. The conversion will happen if
UTF-8 is used as the default encoding.</p>

<p>Also, ICU’s C API uses callback function for error reporting.</p>

<p>A gem with C code can easily access byte arrays. And the conversion in C will be faster
than MRI implementation.</p>

<h2 id="design">Design</h2>

<p>ICU binding should be as transparent as possible. The user only uses the equivalent Ruby
API of ICU. Its module holds a optional internal encoding for the
returning result (usually a string). Since ruby’s string can be any encodings, it have
to be converted to UTF-16 for feeding ICU.</p>

<p>Along the way, <a href="https://silverhammermba.github.io/emberb/examples/"><em>The Definitive Guide to Ruby’s C API</em></a> helps me quite a lot. It’s the most clear reference for Ruby’s C API I’ve seen.</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#unicode" class="page__taxonomy-item" rel="tag">Unicode</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-03-14T00:00:00+01:00">March 14, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=erickguan&text=Bridging+ICU+with+Ruby%20https%3A%2F%2Ferickguan.me%2F2017%2Fbridging-icu-with-ruby" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ferickguan.me%2F2017%2Fbridging-icu-with-ruby" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Ferickguan.me%2F2017%2Fbridging-icu-with-ruby" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2016/hooray-webhooks" class="pagination--pager" title="Hooray, Webhooks
">Previous</a>
    
    
      <a href="/2017/copy-and-paste-bookmarklet" class="pagination--pager" title="Copy and Paste Bookmarklet
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a Comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2020/taylor-vick-M5tzZtFCOfs-unsplash-200.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2020/popular-connectors-for-computers" rel="permalink">Popular connectors for computers
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Pin out tables, some photos and parts of data come from Wikipedia.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2019/jon-tyson-520955-unsplash-200.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2019/a-decade-with-wikipedia" rel="permalink">A decade with Wikipedia
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">I’ve spent a decade with Wikipedia.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2019/Pytorch_logo-200.png" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2019/pytorch-parallel-model" rel="permalink">How PyTorch implements DataParallel?
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">PyTorch can send batches and models to different GPUs automatically with DataParallel(model). How is it possible? I assume you know PyTorch uses dynamic comp...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2018/antenna-503044-unsplash-200.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2018/how-to-have-a-data-science-lab" rel="permalink">How to have a data science lab in 13 steps?
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">TL;DR. You have to be passionate and insane. I would not recommend doing it.

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>


        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Erick Guan. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-36993160-8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-36993160-8', { 'anonymize_ip': false});
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://erickguan.me/2017/bridging-icu-with-ruby";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/2017/bridging-icu-with-ruby"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://fftenacity.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
